loadmodule "rtimer.so"
loadmodule "exec.so"
loadmodule "uac.so"

modparam("uac","restore_mode","none")

modparam("rtimer", "timer", "name=ssp;interval=1;mode=1;")
modparam("rtimer", "exec", "timer=ssp;route=SSP_CHECKER")

route["SSP_CHECKER"] {

    exec_avp("php -f /usr/local/src/php/notify.php", "$avp(s:notify)");

    if ($avp(s:notify) == "1") {
        xlog("notification received\n");

        exec_avp("cat /usr/local/src/location", "$avp(s:f_ip),$avp(s:f_port),$avp(s:t_ip),$avp(s:t_port)");

        // add new IN rule so incoming media will be redirected correctly
        add_in_rule($avp(s:f_ip), $avp(s:f_port), $avp(s:t_ip), $avp(s:t_port));

        exec_avp(
            "php -f /usr/local/src/php/create_register_body.php $avp(s:f_ip) $avp(s:f_port) $avp(s:t_ip) $avp(s:t_port)",
            "$avp(s:body)"
        );

        xlog("$avp(s:body)");

        $uac_req(method)="REGISTER";
        $uac_req(ruri)="sip:192.168.0.31";
        $uac_req(furi)="sip:192.168.0.31";
        $uac_req(turi)="sip:192.168.0.31";
        $uac_req(callid)=$(mb{s.md5});
        $uac_req(hdrs)="Content-Type: application/json\r\n";
        $uac_req(body)=$avp(s:body);
        uac_req_send();

        exec_avp("php -f /usr/local/src/php/end_notification.php");

        exit;
    } else {
        xlog("silently continue\n");
        exit;
    }
}
