loadmodule "rtimer.so"
loadmodule "exec.so"
loadmodule "uac.so"

modparam("uac", "restore_mode", "none")

modparam("rtimer", "timer", "name=ssp;interval=1;mode=1;")
modparam("rtimer", "exec", "timer=ssp;route=SSP_CHECKER")

route["SSP_CHECKER"] {

    $var(server_ip) = SERVER_IP;
    $var(server_port) = SERVER_PORT;
    $var(destination) = "sip:" + SERVER_IP;

    exec_avp("php -f /usr/local/src/php/notify.php", "$avp(s:notify)");

    if ($avp(s:notify) == "1") {

#!ifdef SIMULATE_PACKET_LOSS
        exec_avp("php -f /usr/local/src/php/simulate_packet_loss.php", "$avp(s:simulate)");

        if ($avp(s:simulate) == "1") {
            xlog("stopping packet loss simulation");

            stop_simulate_packet_loss();
            exec_avp("php -f /usr/local/src/php/end_packet_loss_simulation.php", "$avp(s:simulate)");
        }
#!endif

        xlog("notification received\n");

        exec_avp("cat /usr/local/src/location", "$avp(s:f_ip),$avp(s:f_port),$avp(s:t_ip),$avp(s:t_port)");

        // add new IN rule so incoming media will be redirected correctly
        add_in_rule($var(server_ip), $var(server_port), $avp(s:t_port));

        exec_avp(
            "php -f /usr/local/src/php/create_register_body.php $avp(s:f_ip) $avp(s:f_port) $avp(s:t_ip) $avp(s:t_port)",
            "$avp(s:body)"
        );

        xlog("$avp(s:body)");

        $uac_req(method)="REGISTER";
        $uac_req(ruri)=$var(destination);
        $uac_req(furi)=$var(destination);
        $uac_req(turi)=$var(destination);
        $uac_req(callid)=$(mb{s.md5});
        $uac_req(hdrs)="Content-Type: application/json\r\n";
        $uac_req(body)=$avp(s:body);
        $uac_req(evroute)=1;
        uac_req_send();

        exec_avp("php -f /usr/local/src/php/end_notification.php");

        exit;
    } else {
        xlog("silently continue without notification\n");
        exit;
    }
}

#!ifdef SIMULATE_PACKET_LOSS
modparam("rtimer", "timer", "name=packet_loss;interval=1;mode=1;")
modparam("rtimer", "exec", "timer=packet_loss;route=SSP_PACKET_LOSS")

route["SSP_PACKET_LOSS"] {

    exec_avp("php -f /usr/local/src/php/simulate_packet_loss.php", "$avp(s:simulate)");

    if ($avp(s:simulate) == "1") {
        xlog("starting packet loss simulation");
        start_simulate_packet_loss();

        exit;
    } else {
        xlog("silently continue without simulating packet loss\n");
        exit;
    }
}

#!endif
